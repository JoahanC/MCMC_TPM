      SUBROUTINE SATPOS(ABUF1,ABUF2,NT,TS,XYZ,V)
C      DRIVER                                                 3 NOV 80
C
C   WGS-72 PHYSICAL AND GEOPOTENTIAL CONSTANTS
C          CK2= .5*J2*AE**2     CK4=-.375*J4*AE**4
C
      IMPLICIT REAL*8 (A-H,O-Z)
      INTEGER NT
      REAL*8 TS(NT)
      REAL*4 XYZ(3,NT)
      REAL*4 V(3,NT)
	LOGICAL LSGP /.FALSE./
C	COMMON /TYPEFM/ FMTYPE
	COMMON /E1/ EPOCH,DS50,XMO,XNODEO,OMEGAO,EO,XINCL,XNO,XNDT2O,
	1	XNDD6O,BSTAR,X,Y,Z,XDOT,YDOT,ZDOT
C
	PARAMETER (E6A=1.D-6,QO=120.D0,SO=78.D0,TOTHRD=2.D0/3.D0)
	PARAMETER (XJ2=1.082616D-3,XJ3=-.253881D-5,XJ4=-1.65597D-6)
	PARAMETER (XKE=.743669161D-1,XKMPER=6378.135,XMNPDA=1440.D0)
	PARAMETER (AE=1.D0)
	PARAMETER (CK2=0.5D0*XJ2*AE**2,CK4=-.375D0*XJ4*AE**4)
	PARAMETER (QOMS2T=((QO-SO)*AE/XKMPER)**4,S=AE*(1.D0+SO/XKMPER))
	PARAMETER (DE2RA=0.0174532925199433, PI=3.1415926535897900)
        PARAMETER (PIO2=PI/2,TWOPI=2*PI,X3PIO2=1.5D0*PI)
C
      CHARACTER*80 ABUF1,ABUF2
      DATA IEPT/0/
      SAVE
C
      DO IT=1,NT
        DO I=1,3
          XYZ(I,IT) = 0.
          V(I,IT) = 0.
        ENDDO
      ENDDO
C
C     SELECT EPHEMERIS TYPE AND OUTPUT TIMES
C
      READ (ABUF1,7021) EPOCH,XNDT2O,XNDD6O,IEXP,BSTAR,IBEXP
      READ (ABUF2,7022) XINCL,XNODEO,EO,OMEGAO,XMO,XNO
7021  FORMAT(18X,D14.8,1X,F10.8,2(1X,F6.5,I2))
7022  FORMAT(7X,2(1X,F8.4),1X,F7.7,2(1X,F8.4),1X,F11.8)
      XNDD6O=XNDD6O*(10.**IEXP)
      BS = BSTAR*(10.**IBEXP)
      XNODEO=XNODEO*DE2RA
      OMEGAO=OMEGAO*DE2RA
      XMO=XMO*DE2RA
      XINCL=XINCL*DE2RA
      TEMP=TWOPI/XMNPDA/XMNPDA
      XNO=XNO*TEMP*XMNPDA
      XNDT2O=XNDT2O*TEMP
      XNDD6O=XNDD6O*TEMP/XMNPDA
      A1=(XKE/XNO)**TOTHRD
      TEMP=1.5*CK2*(3.*COS(XINCL)**2-1.)/(1.-EO*EO)**1.5
      DEL1=TEMP/(A1*A1)
      AO=A1*(1.-DEL1*(.5*TOTHRD+DEL1*(1.+134./81.*DEL1)))
      DELO=TEMP/(AO*AO)
      XNODP=XNO/(1.+DELO)
      BS = TWOPI/XNODP
      IDEEP=0
C	seems to be period in days in test below
      IF((TWOPI/XNODP/XMNPDA) .GE. .15625) IDEEP=1
C	if (iept.eq.0) then
C	  write (*,*) 'Use SGP:'
C	  read (*,fmt='(a1)') iept
C	  if (iept.eq.1HY .or.iept.eq.1Hy) then
C	    iept = 1
C	  else
	    IEPT = 2+IDEEP
            IF (LSGP) IEPT = 1+2*IDEEP
C	  endif
C	  write (*,*) 'IEPT = ',iept
C	endif
      BSTAR=BSTAR*(10.**IBEXP)/AE
      IFLAG=1
      IF (IEPT.LE.0 .OR. IEPT.GE.6) STOP 'bad IEPT in SATPOS'
      DO 100 IT=1,NT
        TSINCE = TS(IT)
        IF (IEPT.EQ.1) CALL SGP(IFLAG,TSINCE)
        IF (IEPT.EQ.2) CALL SGP4(IFLAG,TSINCE)
        IF (IEPT.EQ.3) CALL SDP4(IFLAG,TSINCE)
        IF (IEPT.EQ.4) CALL SGP8(IFLAG,TSINCE)
        IF (IEPT.EQ.5) CALL SDP8(IFLAG,TSINCE)
   60   X=X*XKMPER/AE
        Y=Y*XKMPER/AE
        Z=Z*XKMPER/AE
        XDOT=XDOT*XKMPER/AE*XMNPDA/86400.
        YDOT=YDOT*XKMPER/AE*XMNPDA/86400.
        ZDOT=ZDOT*XKMPER/AE*XMNPDA/86400.
        IF (IFLAG.LT.0) GO TO 200
        XYZ(1,IT) = X
        XYZ(2,IT) = Y
        XYZ(3,IT) = Z
        V(1,IT) = XDOT
        V(2,IT) = YDOT
        V(3,IT) = ZDOT
100   CONTINUE
7011  FORMAT(29X,D14.8,1X,3F8.4)
7012  FORMAT(6X,F8.7,F8.4,1X,2F11.9,1X,F6.5,I2,4X,F8.7,I2)
      RETURN
200   WRITE (*,*) 'IFLAG LT 0'
      WRITE (*,FMT='(A)') ABUF1
      WRITE (*,FMT='(A)') ABUF2
      RETURN
      END
